<!-- this is  Ụ̵͈̘͚̐͊̅̏ṇ̵͐ĭ̸̮̐c̸̰̥̆ó̷͇̩̒̄̍d̷̛̫̩̪̿̑è̴̢͔̖̯͎̚ -->
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Solaranlage</title>
    <script src="./plotly-cartesian-latest.min.js"></script>
    <script src="./d.js"></script>
    <script src="./tabs.js"></script>
    <script src="./datestuff.js"></script>
    <script src="./common.js"></script>
    <script src="./hexview.js"></script>
    <link rel="stylesheet" href="./style.css" />
</head>
<body>
    <div id="tabs"></div>
    <div id="tab_graph" class="tabcontent">
        <p id="graph_lastupdate">letzte Aktualisierung: </p>
        <label><input type="radio" name="graphdata" value="current" id="graphdata_current" checked="checked" />Aktuelle Daten</label><br />
        <label><input type="radio" name="graphdata" value="history" id="graphdata_history" />Historische Daten</label>
        <div style="padding-left: 20px;">
            von: <input type="date" id="graphdata_hist_from" /> 
            bis: <input type="date" id="graphdata_hist_to" />
            <input type="button" value="Laden" id="graphdata_hist_load" />
        </div>
        <div id="graph" style="width:100%; height: 800px"></div>
    </div>
    <div id="tab_display" class="tabcontent">
        <table>
            <tr>
                <td>
                    <p id="lcd_lastupdate">letzte Aktualisierung: </p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="185" height="140" viewBox="0 0 52.211108 39.511112">
                        <path id="lcd_menu_specialfunc" d="m 50.326676,5.8203931 c 0.204995,0 0.333326,0.223995 0.227662,0.3996577 -0.555321,0.9233126 -1.566965,1.5409653 -2.722606,1.5409653 -1.746961,0 -3.164595,-1.4109682 -3.175262,-3.1552624 -0.011,-1.7519606 1.423301,-3.1955948 3.175262,-3.1952615 1.154641,0 2.165285,0.6159862 2.720939,1.5376321 0.106664,0.1769961 -0.01933,0.4026577 -0.225995,0.4026577 l -2.318615,0 -0.88198,1.2349722 0.88198,1.2346389 2.318615,0 z m -3.784915,2.0509539 -4.415567,4.415567 c -0.551321,0.550988 -1.444634,0.550988 -1.995955,0 -0.550988,-0.551321 -0.550988,-1.444634 0,-1.995955 l 4.415567,-4.4155671 c 0.356325,0.9086462 1.087309,1.6392965 1.995955,1.9959551 z m -4.531565,3.064931 c 0,-0.292327 -0.236994,-0.529321 -0.529321,-0.529321 -0.292327,0 -0.528988,0.236994 -0.528988,0.529321 0,0.291994 0.236661,0.528988 0.528988,0.528988 0.292327,0 0.529321,-0.236994 0.529321,-0.528988 z" />
                        <path id="lcd_status_confirmok" d="m 49.590359,38.100001 -8.8708,0 c -0.667985,0 -1.20964,-0.541655 -1.20964,-1.20964 l 0,-8.870467 c 0,-0.668318 0.541655,-1.209639 1.20964,-1.209639 l 8.8708,0 c 0.667985,0 1.20964,0.541321 1.20964,1.209639 l 0,8.870467 c 0,0.667985 -0.541655,1.20964 -1.20964,1.20964 z m -5.158217,-2.471278 4.636896,-4.636896 c 0.157663,-0.15733 0.157663,-0.412657 0,-0.569987 l -0.570321,-0.57032 c -0.15733,-0.15733 -0.412657,-0.15733 -0.569987,0 l -3.781582,3.781581 -1.765627,-1.765627 c -0.157329,-0.15733 -0.412657,-0.15733 -0.57032,0 l -0.570321,0.570321 c -0.15733,0.15733 -0.15733,0.412657 0,0.57032 l 2.620941,2.620608 c 0.157663,0.157663 0.412991,0.157663 0.570321,0 z" />
                        <path id="lcd_menu_settings" d="m 24.054933,7.8543474 0.969978,0.5599874 c 0.110998,0.063999 0.16233,0.1963289 0.124331,0.3183262 -0.251994,0.8113151 -0.682318,1.544299 -1.244972,2.153285 -0.05133,0.05566 -0.124997,0.08766 -0.200995,0.08766 -0.047,0 -0.095,-0.01367 -0.135664,-0.03633 l -0.969312,-0.559654 c -0.385324,0.333659 -0.879313,0.622986 -1.373302,0.793315 l 0,1.119642 c -0.01067,0.006 -0.01067,0.006 -0.01067,0.006 0,0.126997 -0.08866,0.237995 -0.211661,0.265994 -0.795649,0.178663 -1.650297,0.187662 -2.486278,0 -0.124664,-0.028 -0.213995,-0.138664 -0.213995,-0.266994 l 0,-1.119308 C 17.81274,11.00061 17.318751,10.728283 16.927094,10.387624 l -0.969312,0.559654 c -0.05033,0.01367 -0.09933,0.02633 -0.14633,0.02633 -0.076,0 -0.148663,-0.032 -0.199996,-0.08633 -0.562654,-0.608986 -0.992977,-1.3419696 -1.244972,-2.1532847 -0.03767,-0.1219973 0.01367,-0.2543276 0.124331,-0.3183262 l 0.968978,-0.5613207 c -0.03867,-0.2483278 -0.073,-0.5409879 -0.073,-0.7989821 0,-0.2406612 0.03433,-0.4989887 0.06867,-0.7226504 L 14.485482,5.7727275 c -0.110664,-0.063665 -0.16233,-0.1959956 -0.124331,-0.3183262 0.251995,-0.8113151 0.682318,-1.5442986 1.244972,-2.1529516 0.05567,-0.1323303 0.129331,-0.1643296 0.205329,-0.1643296 0.047,0 0.095,0.013666 0.135664,0.036332 l 0.969311,0.5596541 c 0.385325,-0.3333258 0.879314,-0.622986 1.373303,-0.7933155 l 0.01067,-1.1256414 c 0,0 0,0 0,0 0,-0.1269971 0.08867,-0.2379946 0.211662,-0.2656607 0.795649,-0.1786626 1.650296,-0.1879957 2.486277,-3.333e-4 0.124998,0.027999 0.213996,0.1386636 0.213996,0.266994 l 0,1.1196415 c 0.489655,0.1753294 0.983644,0.4476566 1.375302,0.7883156 l 0.969311,-0.5596541 c 0.05033,-0.013666 0.09933,-0.026333 0.146331,-0.026333 0.076,0 0.148663,0.031999 0.199995,0.086331 0.562654,0.6089863 0.992978,1.3419698 1.244972,2.1532849 0.038,0.1219973 -0.01367,0.2543276 -0.12433,0.3183262 l -0.968979,0.5613207 c 0.03867,0.2483278 0.073,0.5409878 0.073,0.798982 0,0.2409946 -0.03433,0.4989888 -0.06867,0.7226505 l -0.0043,0.076332 z M 21.578322,7.0553653 c 0,-1.0039774 -0.816648,-1.820959 -1.820959,-1.820959 -1.003977,0 -1.820959,0.8169816 -1.820959,1.820959 0,1.0043108 0.816982,1.8209591 1.820959,1.8209591 1.004311,0 1.820959,-0.8166483 1.820959,-1.8209591 z" />
                        <path id="lcd_status_error" d="m 37.97262,36.06238 c 0.361659,0.626986 -0.09233,1.410968 -0.814981,1.410968 l -9.406122,0 c -0.723984,0 -1.175974,-0.784982 -0.814982,-1.410968 l 4.703228,-8.154483 c 0.361992,-0.62732 1.268305,-0.625986 1.62963,0 l 4.703227,8.154483 z m -5.517876,-1.685962 c -0.497988,0 -0.901646,0.403657 -0.901646,0.901646 0,0.497989 0.403658,0.901647 0.901646,0.901647 0.497656,0 0.901314,-0.403658 0.901314,-0.901647 0,-0.497989 -0.403658,-0.901646 -0.901314,-0.901646 z m -0.856314,-3.240927 0.145664,2.66594 c 0.0067,0.124664 0.109664,0.222328 0.234661,0.222328 l 0.951645,0 c 0.124998,0 0.227995,-0.09766 0.234662,-0.222328 l 0.145663,-2.66594 c 0.0073,-0.134664 -0.1,-0.247995 -0.234995,-0.247995 l -1.242305,0 c -0.134997,0 -0.242328,0.113331 -0.234995,0.247995 l 0,0 z" />
                        <path id="lcd_menu_manual" d="m 36.528653,4.2330955 c -0.494322,-0.00933 -0.89898,0.4046575 -0.89898,0.8993131 l 0,1.9229567 -0.176663,0 0,-3.8852459 c 0,-0.4946556 -0.404657,-0.9086463 -0.898979,-0.8993132 -0.479323,0.009 -0.864648,0.4003244 -0.864648,0.8816469 l 0,3.9029122 -0.176329,0 0,-4.7452266 c 0,-0.4946556 -0.404991,-0.9086463 -0.899313,-0.8993131 -0.478989,0.00933 -0.864647,0.4006576 -0.864647,0.8819801 l 0,4.7625596 -0.17633,0 0,-3.8632464 c 0,-0.4946556 -0.404991,-0.9086463 -0.899313,-0.8993132 -0.478989,0.00933 -0.864647,0.4003244 -0.864647,0.8819802 l 0,5.2032164 -0.697651,-0.9596451 C 28.824493,7.024366 28.272838,6.937368 27.878847,7.2240282 27.48519,7.5103551 27.397858,8.0620094 27.684518,8.4560005 l 2.769271,3.8079145 c 0.194329,0.266327 0.508656,0.431657 0.839315,0.43599 l 4.373235,0 c 0.490989,0 0.917646,-0.337992 1.029977,-0.815982 L 37.280969,9.399646 C 37.343635,9.1083192 37.3933,8.7609937 37.3933,8.4466674 l 0,-3.3315918 c 0,-0.4813225 -0.385325,-0.872647 -0.864647,-0.8819801 z" />
                        <path id="lcd_menu_info" d="m 7.0553154,1.4111589 c -3.1169299,0 -5.6442064,2.5282765 -5.6442064,5.6442064 0,3.1182637 2.5272765,5.6445397 5.6442064,5.6445397 3.1172636,0 5.6445396,-2.526276 5.6445396,-5.6445397 0,-3.1159299 -2.527276,-5.6442064 -5.6445396,-5.6442064 z m 0,2.5036104 c 0.5279882,0 0.9559786,0.4279904 0.9559786,0.9556452 0,0.5279881 -0.4279904,0.9559785 -0.9559786,0.9559785 -0.5279881,0 -0.9559785,-0.4279904 -0.9559785,-0.9559785 0,-0.5276548 0.4279904,-0.9556452 0.9559785,-0.9556452 z m 1.2746381,5.78087 c 0,0.1506633 -0.1223306,0.2729939 -0.2729939,0.2729939 l -2.002955,0 c -0.1509966,0 -0.2733272,-0.1223306 -0.2733272,-0.2729939 l 0,-0.546321 c 0,-0.1506633 0.1223306,-0.2729939 0.2733272,-0.2729939 l 0.2729939,0 0,-1.4566339 -0.2729939,0 c -0.1509966,0 -0.2733272,-0.1223306 -0.2733272,-0.2733272 l 0,-0.5459877 c 0,-0.1509966 0.1223306,-0.2733272 0.2733272,-0.2733272 l 1.4566339,0 c 0.1506633,0 0.2729939,0.1223306 0.2729939,0.2733272 l 0,2.2759488 0.2733272,0 c 0.1506633,0 0.2729939,0.1223306 0.2729939,0.2729939 l 0,0.546321 0,0 z" />
                        <path id="lcd_pump_dn" d="m 2.0097622,29.542193 1.7176281,2.913601 1.717628,-2.913601 -3.4352561,0 z m 6.6558504,0 1.7176284,2.913601 1.717628,-2.913601 -3.4352564,0 z m -3.2205943,5.826869 1.6102971,2.730939 1.6102972,-2.730939 -3.2205943,0 z" />
                        <path id="lcd_pump_up" d="m 7.0553154,26.811255 -1.6102971,2.730938 3.2205943,0 -1.6102972,-2.730938 z m -3.3279251,5.644539 -1.7176281,2.913268 3.4352561,0 -1.717628,-2.913268 z m 6.6558507,0 -1.7176284,2.913268 3.4352564,0 -1.717628,-2.913268 z" />
                        <polygon id="lcd_pump_in" points="3.1151,9.7368 2.5998,8.8627 1.6336,8.8627 1.1183,9.7368 1.6336,10.6108 2.5998,10.6108 " transform="matrix(3.3332584,0,0,3.3332584,-1.9260656e-4,5.2394061e-4)" />
                        <g id="lcd_status_sw" transform="matrix(3.3332584,0,0,3.3332584,-1.9260656e-4,5.2394061e-4)">
                            <circle d="m 5.291645,8.5509996 c 0,0.1168718 -0.094743,0.211615 -0.211615,0.211615 -0.1168718,0 -0.211615,-0.094743 -0.211615,-0.211615 0,-0.1168717 0.094743,-0.211615 0.211615,-0.211615 0.1168717,0 0.211615,0.094743 0.211615,0.211615 z" cx="5.08003" cy="8.5509996" r="0.211615" style="fill:none;stroke:#000000;stroke-width:0.1" />
                            <line x1="5.2947001" y1="8.4976997" x2="6.5215001" y2="8.1688995" style="fill:none;stroke:#000000;stroke-width:0.1" />
                            <circle d="m 6.9849452,8.5509996 c 0,0.1168718 -0.094743,0.211615 -0.211615,0.211615 -0.1168717,0 -0.211615,-0.094743 -0.211615,-0.211615 0,-0.1168717 0.094743,-0.211615 0.211615,-0.211615 0.1168717,0 0.211615,0.094743 0.211615,0.211615 z" cx="6.7733302" cy="8.5509996" r="0.211615" style="fill:none;stroke:#000000;stroke-width:0.1" />
                        </g>
                        <path id="lcd_status_sw1" d="m 16.800763,33.021115 -0.361325,0 0,-2.304615 c -0.08733,0.083 -0.200996,0.165996 -0.342326,0.248994 -0.141997,0.083 -0.268994,0.145331 -0.381325,0.18633 l 0,-0.348993 c 0.202329,-0.09533 0.379325,-0.210661 0.530988,-0.345658 0.150664,-0.135997 0.258328,-0.266994 0.32166,-0.394325 l 0.232328,0 0,2.958267 z" />
                        <path id="lcd_status_sw2" d="m 19.629033,32.673456 0,0.347659 -1.94729,0 c -0.003,-0.087 0.01067,-0.170663 0.04167,-0.250994 0.04933,-0.132997 0.128997,-0.263328 0.237995,-0.392325 0.109664,-0.12833 0.26766,-0.277327 0.473322,-0.44599 0.320326,-0.262661 0.536988,-0.470656 0.649652,-0.623986 0.112331,-0.152996 0.168663,-0.29866 0.168663,-0.43499 0,-0.14333 -0.05133,-0.263994 -0.153663,-0.362992 -0.102998,-0.098 -0.236661,-0.14733 -0.401324,-0.14733 -0.173996,0 -0.313327,0.052 -0.417658,0.156997 -0.104997,0.104331 -0.157663,0.248994 -0.158996,0.433656 l -0.371992,-0.038 c 0.02533,-0.27766 0.121331,-0.488989 0.287327,-0.634319 0.165997,-0.14533 0.389658,-0.217995 0.669652,-0.217995 0.28266,0 0.506322,0.07867 0.670651,0.234995 0.16533,0.15733 0.247662,0.351325 0.247662,0.58332 0,0.117997 -0.024,0.233661 -0.07267,0.347659 -0.048,0.113664 -0.128331,0.233995 -0.239995,0.359325 -0.111664,0.126331 -0.29766,0.298993 -0.557654,0.518655 -0.216662,0.182329 -0.355992,0.305993 -0.417657,0.370992 -0.06167,0.06466 -0.112665,0.129664 -0.152997,0.195662 l 1.445301,0 z" />
                        <path id="lcd_status_sw3" d="m 20.018691,32.243132 0.361325,-0.048 c 0.042,0.205328 0.112664,0.352658 0.211995,0.443323 0.1,0.09033 0.221662,0.135664 0.364992,0.135664 0.169996,0 0.313993,-0.059 0.431324,-0.176997 0.116664,-0.117997 0.175662,-0.263994 0.175662,-0.438323 0,-0.165996 -0.05433,-0.302993 -0.162663,-0.410657 -0.108997,-0.107665 -0.246994,-0.161997 -0.414324,-0.161997 -0.06866,0 -0.153663,0.01367 -0.254994,0.04033 l 0.04033,-0.317327 c 0.024,0.0027 0.04333,0.004 0.05833,0.004 0.153664,0 0.292327,-0.04033 0.415658,-0.120664 0.123664,-0.08033 0.185329,-0.204328 0.185329,-0.371991 0,-0.132331 -0.04533,-0.242661 -0.13533,-0.328993 -0.08967,-0.08733 -0.205662,-0.130997 -0.347659,-0.130997 -0.140664,0 -0.257994,0.04433 -0.351326,0.13233 -0.094,0.08833 -0.15433,0.221662 -0.180996,0.398325 l -0.361325,-0.06433 c 0.04367,-0.242661 0.144664,-0.430657 0.300993,-0.563987 0.156997,-0.132997 0.351993,-0.199996 0.584987,-0.199996 0.160663,0 0.30866,0.035 0.44399,0.103331 0.134997,0.06933 0.238662,0.16333 0.31066,0.28266 0.07133,0.119331 0.107664,0.245662 0.107664,0.379992 0,0.126997 -0.03433,0.242994 -0.102997,0.347659 -0.06833,0.104331 -0.16933,0.187329 -0.302994,0.248994 0.17433,0.04 0.309327,0.123664 0.405991,0.250661 0.096,0.125997 0.143997,0.28466 0.143997,0.474656 0,0.256994 -0.09333,0.475323 -0.281327,0.654319 -0.186996,0.178996 -0.424324,0.267994 -0.710984,0.267994 -0.258661,0 -0.473323,-0.07666 -0.644319,-0.230995 -0.170663,-0.153663 -0.267994,-0.353325 -0.291993,-0.598987 z" />
                        <path id="lcd_status_sw4" d="m 23.464613,33.021115 0,-0.704984 -1.277971,0 0,-0.331993 1.344636,-1.908957 0.29566,0 0,1.908957 0.397658,0 0,0.331993 -0.397658,0 0,0.704984 -0.362325,0 z m 0,-1.036977 0,-1.32797 -0.921979,1.32797 0.921979,0 z" />
                        <path id="lcd_status_sw5" d="m 15.43846,36.847362 0.379992,-0.03233 c 0.02833,0.185329 0.09333,0.323992 0.195662,0.41699 0.102998,0.09333 0.226328,0.139997 0.370992,0.139997 0.174329,0 0.321659,-0.06567 0.441656,-0.196662 0.120998,-0.131997 0.18133,-0.305993 0.18133,-0.522655 0,-0.206662 -0.05767,-0.369325 -0.173663,-0.488656 -0.115997,-0.11933 -0.267327,-0.178996 -0.455323,-0.178996 -0.116664,0 -0.221662,0.02667 -0.31566,0.07966 -0.094,0.05267 -0.167329,0.121331 -0.220995,0.205662 l -0.339325,-0.04367 0.285326,-1.5133 1.464968,0 0,0.345659 -1.175641,0 -0.158996,0.791649 c 0.176996,-0.123664 0.362658,-0.185329 0.556987,-0.185329 0.257328,0 0.47399,0.08933 0.650986,0.26766 0.176996,0.17833 0.265327,0.407325 0.265327,0.687318 0,0.266661 -0.078,0.497323 -0.233328,0.691318 -0.189329,0.237995 -0.44699,0.357325 -0.773649,0.357325 -0.267994,0 -0.486989,-0.07467 -0.656319,-0.224994 -0.169329,-0.149997 -0.266327,-0.348993 -0.290327,-0.596654 z" />
                        <path id="lcd_status_sw6" d="m 19.604367,35.394395 -0.359659,0.02833 c -0.032,-0.141997 -0.07733,-0.245662 -0.13633,-0.309327 -0.098,-0.103664 -0.218995,-0.154996 -0.362325,-0.154996 -0.114998,0 -0.215996,0.032 -0.302994,0.09666 -0.113997,0.083 -0.203662,0.204329 -0.26966,0.363325 -0.06533,0.15933 -0.09933,0.386325 -0.102331,0.681318 0.08733,-0.13233 0.193662,-0.231328 0.319659,-0.29566 0.125664,-0.06367 0.257994,-0.096 0.395991,-0.096 0.241328,0 0.446324,0.08833 0.615987,0.265994 0.169329,0.177662 0.254327,0.40699 0.254327,0.687984 0,0.185329 -0.04033,0.356659 -0.119997,0.515989 -0.07966,0.158329 -0.189329,0.280327 -0.328659,0.364991 -0.138997,0.08433 -0.296994,0.125997 -0.47399,0.125997 -0.30166,0 -0.547321,-0.11033 -0.737317,-0.332659 -0.190662,-0.221661 -0.285326,-0.586987 -0.285326,-1.095975 0,-0.569321 0.104997,-0.982978 0.315659,-1.241639 0.182996,-0.224995 0.42999,-0.337992 0.741317,-0.337992 0.231328,0 0.421324,0.065 0.56932,0.195329 0.14833,0.129663 0.236662,0.309326 0.266328,0.538321 z M 18.1274,36.664033 c 0,0.124997 0.02667,0.244328 0.07966,0.358325 0.05267,0.113664 0.126997,0.200329 0.221661,0.259994 0.09533,0.05967 0.195329,0.08966 0.29966,0.08966 0.152997,0 0.283994,-0.06166 0.393658,-0.184996 0.109664,-0.123664 0.164663,-0.290993 0.164663,-0.502322 0,-0.203662 -0.05433,-0.363992 -0.162663,-0.481322 -0.108331,-0.117331 -0.244661,-0.175663 -0.409324,-0.175663 -0.163996,0 -0.30266,0.05833 -0.416324,0.175663 -0.113997,0.11733 -0.170996,0.27066 -0.170996,0.460656 z" />
                        <path id="lcd_status_sw7" d="m 20.040357,35.059069 0,-0.347659 1.906957,0 0,0.281327 c -0.187329,0.199329 -0.372992,0.46499 -0.557654,0.795649 -0.183663,0.330659 -0.326326,0.671318 -0.426657,1.020644 -0.07267,0.246994 -0.118664,0.516322 -0.13833,0.809982 l -0.371992,0 c 0.0043,-0.231995 0.04933,-0.511656 0.136664,-0.840315 0.087,-0.327659 0.211995,-0.644652 0.374324,-0.949312 0.16333,-0.30466 0.336326,-0.561654 0.519989,-0.770316 l -1.443301,0 z" />
                        <path id="lcd_status_sw8" d="m 22.862293,36.021381 c -0.149996,-0.05467 -0.261327,-0.132997 -0.333992,-0.235328 -0.072,-0.101331 -0.108331,-0.223329 -0.108331,-0.365325 0,-0.214662 0.077,-0.394658 0.231328,-0.540655 0.15433,-0.145997 0.358659,-0.219328 0.61432,-0.219328 0.257327,0 0.464656,0.07467 0.621652,0.223995 0.15633,0.149663 0.234662,0.331326 0.234662,0.546321 0,0.13633 -0.03567,0.254994 -0.106998,0.356658 -0.07233,0.100665 -0.180662,0.178996 -0.326659,0.233662 0.180329,0.059 0.318326,0.153663 0.412991,0.285327 0.094,0.130997 0.14133,0.288327 0.14133,0.469989 0,0.252328 -0.08933,0.463656 -0.266994,0.635319 -0.17833,0.17133 -0.412991,0.256994 -0.703651,0.256994 -0.290994,0 -0.524655,-0.08566 -0.702984,-0.257994 -0.17833,-0.171996 -0.267661,-0.386658 -0.267661,-0.643985 0,-0.191329 0.04867,-0.351659 0.145997,-0.481323 0.097,-0.128997 0.235328,-0.217662 0.41499,-0.264327 z m -0.07267,-0.612986 c 0,0.138996 0.04533,0.252994 0.134664,0.341325 0.08967,0.08866 0.206329,0.133331 0.349659,0.133331 0.13933,0 0.253661,-0.044 0.342992,-0.131664 0.089,-0.088 0.132997,-0.195662 0.132997,-0.32266 0,-0.132997 -0.04533,-0.243994 -0.136997,-0.334659 -0.092,-0.09066 -0.205995,-0.135663 -0.342992,-0.135663 -0.137997,0 -0.252661,0.04433 -0.343659,0.13233 -0.09133,0.08833 -0.136664,0.194662 -0.136664,0.31766 z m -0.116664,1.360636 c 0,0.102997 0.02467,0.202995 0.07366,0.299326 0.04867,0.09667 0.121331,0.17133 0.217995,0.223995 0.09666,0.053 0.200329,0.07966 0.311327,0.07966 0.172996,0 0.315659,-0.05566 0.42799,-0.167329 0.112664,-0.110998 0.168996,-0.252328 0.168996,-0.423991 0,-0.173996 -0.05767,-0.318326 -0.173662,-0.43199 -0.115998,-0.113998 -0.261328,-0.170996 -0.435657,-0.170996 -0.169996,0 -0.31066,0.05633 -0.422324,0.168996 -0.111998,0.112997 -0.16833,0.253661 -0.16833,0.422324 z" />
                        <text id="lcd_text0" style="font-size:4.7px;font-family:Consolas, monospace; white-space:pre;" x="1.8413624" y="18.344112"></text>
                        <text id="lcd_text1" y="23.51807" x="1.8413624" style="font-size:4.7px;font-family:Consolas, monospace; white-space:pre;"></text>
                    </svg>
                </td>
                <td id="lcddata_raw"></td>
            </tr>
        <tr>
            <td id="currdata_list"></td>
            <td id="currdata_raw"></td>
        </tr>
    </table>
    </div>
    <div id="tab_debug" class="tabcontent">
    </div>
    <script>

d.ea(window, "load", function()
{
    foo = new SolarManager();
});

function SolarManager()
{
    this.plot_latestdata = [];
    this.tabs = new TabPane(d.ebi("tabs"), false);
    this.lcd = new ProzedaLCDisplay(this);
    this.lcd_refresh = d.ac(d.ebi("lcd_lastupdate"), d.ctn("nie"));
    this.plot_refresh = d.ac(d.ebi("graph_lastupdate"), d.ctn("nie"));
    this.dateformat = new DateFormat("DD.MM.YYYY HH:mm:ss.fff");
    this.ptCurrLogdata = new ParamTable("currentdata");

    this.ptDebugInfo = new ParamTable("debugtable");
    
    this.psUpdatePlot = new Postscaler(5);
    this.updateplot = false;
    
    this.settings = null;
    var othis = this;

    this.timer = new Timer(1000, function() { othis.tick(); });
    // instead of loading via XHR, the settings could be directly integrated via a script
    XhrGetJson("settings.php", function(success, data, time) { othis.settingsloaded(success, data, time); });

    this.jhrCurrdata = new JsonHttpRequest("data_current.php", null, function(obj, success, data) {othis.currentdata_loaded(success, data); }, true);
    this.jhrLastdata = new JsonHttpRequest("data_last.php",  null, function(obj, success, data) {othis.latestdata_loaded(success, data); }, true);
    this.jhrDispdata = new JsonHttpRequest("display.php",      null, function(obj, success, data) {othis.displaydata_loaded(success, data); }, true);
    this.jhrSysinfo =  new JsonHttpRequest("sysinfo.php",      null, function(obj, success, data) {othis.sysinfo_loaded(success, data); }, true);

    this.hv = new HexView(null, 16);
}


SolarManager.prototype = 
{
    settingsloaded : function(success, data, time)
    {
        if(success == false || data == null)
        {
            alert("Einstellungen konnten nicht geladen werden.");
            return;
        }
        this.settings = data;
        this.init();
    },

    prozedavalFormatter : function(coltype)
    {
        //TODO: get rid of quirks
        switch (coltype) {
            case 0x01: return [function(value) { return value.toFixed(1); }, "°C"];
            case 0x02: return [function(value) { return value.toString(); }, "W"];
            case 0x07: return [function(value) { return value.toString(); }, "kWh"];
            case 0x08: return [function(value) { return (value % 100) + "." + Math.floor(value / 100) + "."; }, ""];
            case 0x09: return [function(value) { return Math.floor(value / 60) + ":" + d.s.padl(value % 60, 2, "0"); }, ""];
            case 0x0F: return [function(value) { return value.toString(); }, "h"];
            case 0x10: return [function(value) { return value.toString(); }, "s"];
            case 0x13: return [function(value) { return value.toString(); }, "l/min"];
            case 0x1B: return [function(value) { return value.toString(); }, "l/min"];
            case 0xFE: return [function(value) { console.log("date: ", value); return (new Date(value * 1000)).toLocaleString(); }, ""];
            default: return [function(value) { return "0x" + value.toString(16).toUpperCase(); }, ""];
        }
    },

    init : function()
    {
        var othis = this;
        this.tabs.AddTab("Diagramm", d.ebi("tab_graph"));
        this.tabs.AddTab("Aktuelle Daten/Display", d.ebi("tab_display"));
        this.tabs.AddTab("Debug", d.ebi("tab_debug"));

        //add a dummy tab for debug
        /*var li = d.ac(this.tabs.container, d.ce("li"));
        d.ac(li, d.ce("input"), {"type" : "checkbox"});*/

        this.tabs.onchange = function(oldtab, newtab) { othis.tabchange(oldtab, newtab); }

        this.plot = new ProzedaPlot("graph", this);

        this.jhrCurrdata.load();
        this.jhrLastdata.load();

        var othis = this;
        this.ptCurrLogdata.addRow("Empfangen", null, null, 0, function(value) {
            return othis.dateformat.Format(new Date(value*1000)); 
        });
        // some manual adjustments to get a slightly better look
        for(var i = 0; i < this.settings.system.length; i++)
        {
            var row = this.settings.system[i];
            var meh = this.prozedavalFormatter(row[0]);
            this.ptCurrLogdata.addRow(row[2], meh[1], null, i+1, meh[0], row[3] == true ? "hidden" : undefined);
        }

        d.ac(d.ebi("currdata_list"), this.ptCurrLogdata.table);

        this.hvLcddata_target = d.ac(d.ebi("lcddata_raw"), d.ctn());
        this.hvCurrdata_target = d.ac(d.ebi("currdata_raw"), d.ctn());
        
        // debug tab
        var pdi = this.ptDebugInfo;
        pdi.addSep("RAM");
        pdi.addRow("Garbage Collector", "KiB", 0, null, function(obj) { return Math.round(obj.thisram / 1024)});
        pdi.addRow("Log-Kapazität", "Einträge", 0, null, function(obj) { return obj.ramlog.size; });
        pdi.addRow("Log-Belegung", "Einträge", 0, null, function(obj) { return obj.ramlog.items; });
        
        pdi.addSep("Prozeda-Reader");
        pdi.addRow("Stats seit", null, 0, null, function(obj) { return othis.dateformat.Format(new Date(obj.reader.resettime * 1000)); });
        pdi.addRow("Log", "Nachrichten", 0, null, function(obj) { return obj.reader.logdata; });
        pdi.addRow("Display", "Nachrichten", 0, null, function(obj) { return obj.reader.displaydata; });
        pdi.addRow("Rx-Fehler", "", 0, null, function(obj) { return obj.reader.rxerror; });
        pdi.addRow("HW-Resets", "", 0, null, function(obj) { return obj.reader.reset; });
        pdi.addRow("Fehlende Daten", "", 0, null, function(obj) { return obj.reader.datamissing; });

        pdi.addSep("Laufzeit HTTP-Requests");
        pdi.addRow("Aktuelle Daten", "ms", 1, null, function(obj) {return othis.jhrCurrdata.lastresp.duration; })
        pdi.addRow("Display-Daten", "ms", 2, null, function(obj) {return othis.jhrDispdata.lastresp.duration; })
        pdi.addRow("Letzte Daten", "ms", 3, null, function(obj) {return othis.jhrLastdata.lastresp.duration; })
        pdi.addRow("Statistik", "ms", 0, null, function(obj) {return othis.jhrSysinfo.lastresp.duration; })

        pdi.addSep("UART-Trace");
        // add rows for trace control
        var tr = d.acp(d.ce("tr"), d.acp(d.ce("td"), d.ctn("Aufzeichnung")));
        var td = d.ac(tr, d.ce("td", {"colSpan" : 2}));
        var tracetimes = [["10 s", 10], ["20 s", 20], ["30 s", 30], ["1 min", 60, true], ["2 min", 120], ["5 min", 300], ["10 min", 600], ["30 min", 1800]];
        var durationcs = d.ac(td, d.cs(tracetimes, {"style" : {"textAlign" : "right"}}));

        var startbtn = d.ac(td, d.ce("input", {"type" : "button", "value" : "Start"}));
        startbtn.onclick = function()
        {
            var duration = durationcs.options[durationcs.selectedIndex].value;
            XhrGetJson("filetrace.php", null, {"action" : "start", "duration" : duration})
        }
        var stopbtn = d.ac(td, d.ce("input", {"type" : "button", "value" : "Stopp"}));
        stopbtn.onclick = function()
        {
            XhrGetJson("filetrace.php", null, {"action" : "stop"})
        }
        pdi.addCustomRow(tr);

        pdi.addRow("Datei", null, 0, null, function(obj) { return obj.tracing.file; });
        pdi.addRow("Start", null, 0, null, function(obj) { return obj.tracing.start == null ? "-" : othis.dateformat.Format(new Date(obj.tracing.start * 1000)); });
        pdi.addRow("Ende", null, 0, null, function(obj) { return obj.tracing.stop == null ? "-" : othis.dateformat.Format(new Date(obj.tracing.stop * 1000)); });
        pdi.addRow("Restlaufzeit", "s", 0, null, function(obj) { return Math.round(obj.tracing.remaining); });
        pdi.addRow("Dateigröße", "KiB", 0, null, function(obj) { return Math.round(obj.tracing.size/1024); });
        
        
        tr = d.ce("tr");
        var chkShowRawdata = d.ce("input", {"type" : "checkbox"});
        d.ac(tr, d.acp(d.ce("td", {"colSpan" : 3}), d.acp(d.ce("label"), [chkShowRawdata, d.ctn("Rohdaten anzeigen")])));
        chkShowRawdata.onclick = function()
        {
            othis.chkShowRawdata_click(this);
        }
        pdi.addCustomRow(tr);
        

        d.ac(d.ebi("tab_debug"), pdi.table);
        
        this.timer.start();
    },

    chkShowRawdata_click : function(sender)
    {
        if(sender.checked == true)
        {
            this.jhrCurrdata.params["raw"] = "true";
            this.jhrDispdata.params["raw"] = "true";
        }
        else
        {
            delete this.jhrCurrdata.params["raw"]
            delete this.jhrDispdata.params["raw"]
        }
    },

    currentdata_loaded : function(success, data)
    {
        if(success == false || data == null) return;
        if(this.tabs.selectedtab == 1)
        {
            //only update the table when it's shown
            this.ptCurrLogdata.update(data.data);
        }
        if(this.jhrLastdata.running == false && this.psUpdatePlot.ticked == true)
        {
            //only update the diagram when the "base data" are already loaded
            //and only every x seconds
            this.psUpdatePlot.ticked = false;
            this.plot.updateCurrent(data.data);
            this.plot_refresh.textContent = this.dateformat.Format(new Date());
        }
        this.ptDebugInfo.update(null, 1);

        this.hvCurrdata_target.textContent = (data.raw != undefined) ? this.hv.renderAscii(d.s.ba2s(d.s.hs2ba(data.raw))) : "";
    },

    latestdata_loaded : function(success, data, time)
    {
        if(success == false || data == null) return;
        this.plot.initCurrent(data.data);
        this.plot_refresh.textContent = this.dateformat.Format(new Date());
        this.ptDebugInfo.update(null, 3);
    },

    displaydata_loaded : function(success, data, time)
    {
        if(success == false || data == null) return;
        this.lcd_refresh.textContent = this.dateformat.Format(new Date());
        this.lcd.update(data);
        this.ptDebugInfo.update(null, 2);

        this.hvLcddata_target.textContent = (data.raw != undefined) ? this.hv.renderAscii(d.s.ba2s(d.s.hs2ba(data.raw))) : "";
    },

    sysinfo_loaded : function(success, data, time)
    {
        this.ptDebugInfo.update(data, 0);

    },

    tick : function()
    {
        this.psUpdatePlot.tick();
        this.jhrCurrdata.load();
        if(this.tabs.selectedtab == 1)
        {
            // current data & display is selected
            this.jhrDispdata.load();
        }
        else if(this.tabs.selectedtab == 2)
        {
            this.jhrSysinfo.load();
        }
    },

    tabchange : function(oldtab, newtab)
    {
        if(newtab == 1)
        {
            this.jhrDispdata.load();
        }
        else if(newtab == 2)
        {
            this.jhrSysinfo.load();
        }
    },
}

function ProzedaPlot(containerId, manager)
{
    this.currentData = { "x" : [], "y" : [] }; // current (latest and updated) data
    this.historyData = { "x" : [], "y" : [] }; // historic data
    this.columnDefs = [];

    this.plotdata = []; // plotdata that are being displayed

    this.currentDisplay = 0; // 0: current data, 1: historic data

    this.containerId = containerId;
    this.solarmanager = manager;
    this.initPlot();
}

ProzedaPlot.prototype =
{
    initPlot : function()
    {
        //prepare plotly
        /*var selectorOptions = {
            buttons: [
                { step: 'month', stepmode: 'backward', count: 1, label: '1 Monat'},
                { step: 'month', stepmode: 'backward', count: 6, label: '6 Monate'},
                { step: 'year', stepmode: 'todate', count: 1, label: 'Jahr'},
                { step: 'year', stepmode: 'backward', count: 1, label: '1 Jahr'},
                { step: 'all', label: 'Alles' },
            ]
        };*/

        var layout = {
            xaxis: {
                /*rangeselector: buttons: [
                    { step: 'month', stepmode: 'backward', count: 1, label: '1 Monat'},
                    { step: 'month', stepmode: 'backward', count: 6, label: '6 Monate'},
                    { step: 'year', stepmode: 'todate', count: 1, label: 'Jahr'},
                    { step: 'year', stepmode: 'backward', count: 1, label: '1 Jahr'},
                    { step: 'all', label: 'Alles' },
                ],*/
                rangeslider: {}
            },
            yaxis1: {
                title: "Leistung [%]",
                fixedrange: true,
                domain: [0, 0.45]
            },
            yaxis2: {
                title: "Temperatur [°C]",
                fixedrange: true,
                domain: [0.55, 1]
            },
        };

        //clear plotdata
        this.plotdata.length = 0;
        // prepare data series
        var columns = this.solarmanager.settings.system;
        
        for (var i = 0; i < columns.length; i++) {
            var col = columns[i];
            var coltype = col[0];
            var colhidden = col[3] || false;
            var colname = col[2];
            if (coltype == 1 && colhidden == false) 
            {
                // non-hidden temperature-column
                // __colid must be offset by 1 because data contains the timestamp as first item
                var series = { "name": colname, "mode": "lines", "line" : {"width": 1 }, "x": [], "y": [], "xaxis": 'x', "yaxis": "y2", "__colid": (i + 1) };
                this.plotdata.push(series);
            }
            else if (coltype == 10 && colhidden == false) 
            {
                // non-hidden output-column
                var series = { "name": colname, "mode": "lines", "line" : {"width": 1 }, "x": [], "y": [], "xaxis": 'x', "yaxis": "y1", "__colid": (i + 1) };
                this.plotdata.push(series);
            }
        }

        var othis = this;
        d.ebi("graphdata_current").checked = true;
        d.ea(d.ebi("graphdata_current"), "click", function() { othis.updatePlot(0, true); });
        d.ea(d.ebi("graphdata_history"), "click", function() { othis.updatePlot(1, true); });
        d.ea(d.ebi("graphdata_hist_load"), "click", function() { d.ebi("graphdata_history").click(); othis.loadHistorydata(); });
        

        Plotly.plot(this.containerId, this.plotdata, layout, { scrollZoom: true });
    },

    initCurrent : function(data)
    {
        // first set of data contains historic rows
        if(this.solarmanager.settings.system.length == 0)
        {
            return false;
        }

        for (var i = 0; i < data.length; i++) 
        {
            var row = data[i];
            this.currentData.x.push(new Date(row[0] * 1000));
            for (var j = 0; j < this.plotdata.length; j++) 
            {
                // holy f... this is quite messed up
                var target = this.currentData.y[j];
                if(target === undefined)
                {
                    this.currentData.y.push([]);
                }
                this.currentData.y[j].push(row[this.plotdata[j].__colid]);
            }
        }
        
        this.updatePlot(0);
    },

    updateCurrent : function(row)
    {

        this.currentData.x.push(new Date(row[0] * 1000));
        for (var j = 0; j < this.plotdata.length; j++) 
        {
            this.currentData.y[j].push(row[this.plotdata[j].__colid]);
        }
        
        this.updatePlot(0);
    },

    setHistoric : function(data)
    {
        console.log(this);
        this.historyData = { "x" : [], "y" : [] };
        
        for(var i = 0; i < data.length; i++)
        {
            var row = data[i];
            this.historyData.x.push(new Date(row[0] * 1000));
            for (var j = 0; j < this.plotdata.length; j++) 
            {
                if(this.historyData.y[j] == undefined)
                {
                    this.historyData.y.push([]);
                }
                this.historyData.y[j].push(row[this.plotdata[j].__colid]);
            }
        }
        this.updatePlot(1);
    },

    loadHistorydata : function()
    {
        var datefrom = d.ebi("graphdata_hist_from").valueAsNumber;
        var dateto = d.ebi("graphdata_hist_to").valueAsNumber;
        if(datefrom == undefined || dateto == undefined)
        {
            alert("Dieser Browser unterstützt keine Datepicker. Bitte einen modernen Browser verwenden.")
            return;
        }
        if(isNaN(datefrom) || isNaN(dateto))
        {
            alert("Kein Datumspaar gesetzt");
            return;
        }

        var othis = this;
        XhrGetJson("fslog.php", function(success, data, time) 
        {
            if(success == false)
            {
                alert("Fehler beim Laden der Daten");
            }
            othis.setHistoric(data);

        }, {"action" : "chart", "datefrom" : datefrom / 1000, "dateto" : dateto / 1000 })
    },

    updatePlot : function(plottype, changePlottype)
    {
        if(changePlottype == true)
        {
            this.currentDisplay = plottype;
        }
        else if(plottype != this.currentDisplay)
        {
            return;
        }

        var ref = null;

        if(this.currentDisplay == 0)
            ref = this.currentData;
        else
            ref = this.historyData;

        for(var i = 0; i < this.plotdata.length; i++)
        {
            this.plotdata[i].x = ref.x;
            this.plotdata[i].y = ref.y[i];
        }
        Plotly.redraw(this.containerId);
    }
}

function ProzedaLCDisplay(manager)
{
    this.manager = manager;
    this.swelems = [];
    var sw_prefix = "lcd_status_sw"
    var el = d.ebi(sw_prefix);
    this.setElementActive(el, false);
    this.swelems.push(el);
    for(let i = 0; i < 8; i++)
    {
        el = d.ebi(sw_prefix + (i+1));
        this.setElementActive(el, false);
        this.swelems.push(el);
    }

    var symbols = ["lcd_menu_info", "lcd_menu_settings", "lcd_menu_manual", "lcd_menu_specialfunc", "lcd_status_error", "lcd_status_confirmok"];
    for (i = 0; i < symbols.length; i++) 
    {
        var s = symbols[i];
        this.setElementActive(d.ebi(s), false);
    }

    this.pumpelems = [];
    var foo = ["lcd_pump_in", "lcd_pump_dn", "lcd_pump_up"];
    for(i = 0; i < foo.length; i++)
    {
        var s = foo[i];
        var el = d.ebi(s);
        this.setElementActive(el, false);
        this.pumpelems.push(el);
    }

    this.textelems = [];
    this.textelems.push(d.ac(d.ebi("lcd_text0"), d.ctn()));
    this.textelems.push(d.ac(d.ebi("lcd_text1"), d.ctn()));
}

ProzedaLCDisplay.prototype = 
{
    setElementActive : function(element, active)
    {
        element.style.opacity = (active == true) ? 1 : 0.2;
    },

    setPumpStatus : function(status)
    {
        // 0: off, 1: down, 2: up
        this.setElementActive(this.pumpelems[0], status != 0);
        this.setElementActive(this.pumpelems[1], status == 1);
        this.setElementActive(this.pumpelems[2], status == 2);
    },

    update : function(data)
    {
        // I'm not quite happy about this...
        var foo = ["menu_info", "menu_settings", "menu_manual", "menu_specialfunc", "status_error", "status_confirmok"];
        for (var i = 0; i < foo.length; i++) 
        {
            var item = foo[i];
            this.setElementActive(d.ebi("lcd_" + item), data[item]);
        }

        this.textelems[0].textContent = data.text[0];
        this.textelems[1].textContent = data.text[1];

        this.setPumpStatus(data.status_pump);
        for (let i = 0; i < 9; i++) {
            this.setElementActive(this.swelems[i], data.status_outputs.indexOf(i) != -1);
        }
    }
}





    </script>
</body>
</html>